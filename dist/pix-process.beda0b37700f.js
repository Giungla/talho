"use strict";(()=>{var d="; ";function a(e){let r=document.cookie.split(d).find(t=>{let{name:o}=l(t);return o===e});return r?l(r).value:!1}function l(e){let[r,t]=e.split("=");return{name:r,value:t}}function f(e,r,t={}){if(e.length===0)throw new Error("'setCookie' should receive a valid cookie name");if(!["string","number","boolean"].includes(typeof r)||r.toString().length===0)throw new Error("'setCookie' should receive a valid cookie value");let o=[`${e}=${r}`];t?.expires&&t?.expires instanceof Date&&o.push("expires="+t.expires.toUTCString()),t.maxAge&&o.push(`maxAge=${t.maxAge}`),t?.sameSite&&typeof t?.sameSite=="string"&&o.push(`SameSite=${t?.sameSite}`),t?.path&&o.push(`path=${t?.path}`),t?.domain&&o.push(`domain=${t?.path}`),t?.httpOnly&&o.push("HttpOnly"),t?.secure&&o.push("Secure");let n=o.join(d);return document.cookie=n,n}var D=401,h="__Host-Talho-AuthToken",m="__Host-Talho-Session-Cookie",x="X-Talho-Session";function k(e){!e||e.status!==D||(location.href=i("/acessos/entrar",{redirect_to:encodeURIComponent(location.pathname)}))}function v(e){let r=e?.headers.get(x);r&&f(m,r,{path:"/",secure:!0,sameSite:"Strict",expires:new Date(Date.now()+S(90))})}function u(e){return v(this),k(this),{message:e,succeeded:!1}}function E(e){return v(this),{data:e,succeeded:!0}}function g(e=[],r="GET"){let t=new Headers({Accept:"application/json","Content-Type":"application/json"});for(let[p,w]of e)t.set(p,w);let o=a(m);o&&t.set(x,o);let n=a(h);return n&&t.set("Authorization",n),{method:r,headers:t}}function S(e){return 86400*1e3*e}var T=new Intl.NumberFormat("pt-BR",{currency:"BRL",style:"currency"});var s=null,L="oculto";function c(e,r=document){return r?r.querySelector(e):s}function A(e,r,t){e&&e.setAttribute(r,t)}function R(e,r){return e?e.getAttribute(r):s}function b(e,r,t){return e?e.classList.toggle(r,t):!1}function _(e){return b(c("[data-wtf-loader]"),L,!e)}function i(e,r={}){let t=new URL(`${location.protocol}//${location.hostname}`),o=new URL(e,t);for(let[n,p]of Object.entries(r))o.searchParams.set(n,p);return o.toString()}function y(e){if(typeof e!="string")return null;try{return JSON.parse(e)}catch{return s}}function P(e){return e===s}var O={AC:"Acre",AL:"Alagoas",AP:"Amap\xE1",AM:"Amazonas",BA:"Bahia",CE:"Cear\xE1",DF:"Distrito Federal",ES:"Esp\xEDrito Santo",GO:"Goi\xE1s",MA:"Maranh\xE3o",MT:"Mato Grosso",MS:"Mato Grosso do Sul",MG:"Minas Gerais",PA:"Par\xE1",PB:"Para\xEDba",PR:"Paran\xE1",PE:"Pernambuco",PI:"Piau\xED",RJ:"Rio de Janeiro",RN:"Rio Grande do Norte",RS:"Rio Grande do Sul",RO:"Rond\xF4nia",RR:"Roraima",SC:"Santa Catarina",SP:"S\xE3o Paulo",SE:"Sergipe",TO:"Tocantins"},H=Object.keys(O),U=Object.values(O);var I="",N="https://xef5-44zo-gegm.b2.xano.io";var{createApp:q}=window.Vue,C="00:00:00",M=`${N}/api:5lp3Lw8X`,G=q({name:"PIXProcessPage",setup(){return{hasEventSource:Vue.shallowRef(s)}},data(){return{now:Date.now(),hasCopied:!1,order:s,nowInterval:s}},async created(){this.hasEventSource="EventSource"in window;let r=new URLSearchParams(location.search).get("order");if(!r){location.href="/";return}let t=await this.getOrder(r);if(!t.succeeded||t.data.payment_method!=="pix"){location.href=i("/");return}if(this.order=t.data,this.setQRImage(),t.data.pago){setTimeout(()=>{location.href=i("/pagamento/confirmacao-do-pedido",{order:r})},5e3);return}if(!t.data.expired&&(this.nowInterval=setInterval(()=>this.now=Date.now(),1e3),this.hasEventSource))return this.pollOrder(r)},methods:{pollOrder(e){let r=new EventSource(`${M}/confirm-pix/${e}`);r.addEventListener("message",async t=>{let o=y(t.data);P(o)||(this.patchOrder({...o,expired:C===this.timmer||o.expired}),(this.hasPaid||this.isExpired)&&(r.readyState!==r.CLOSED&&r.close(),this.clearInterval()),this.hasPaid&&setTimeout(()=>{location.href=i("/pagamento/confirmacao-do-pedido",{order:e})},5e3))}),document.addEventListener("beforeunload",()=>{r.readyState!==r.CLOSED&&(r.close(),this.clearInterval())})},patchOrder({pago:e,expired:r,total:t}){this.order&&(this.order.pago=e,this.order.total=t,this.order.expired=r)},async getOrder(e){let r="Falha ao capturar o pedido";try{let t=await fetch(`${M}/confirm-pix/${e}/rest`,{...g()});if(!t.ok){let n=await t.json();return u.call(t,n?.message??r)}let o=await t.json();return E.call(t,o)}catch{return u(r)}},async handleCopyQRCode(){if(!this.hasCopied){if(this.hasCopied=!0,navigator.clipboard.writeText)await navigator.clipboard.writeText(this.order?.qrcode_text??"");else{let e=document.createElement("input");document.body.appendChild(e),e.value=this.order?.qrcode_text??"",e.select(),document.execCommand("copy"),document.body.removeChild(e)}setTimeout(()=>this.hasCopied=!1,3e3)}},setQRImage(){let e=c("[data-wtf-qr-code-image]");e&&(e.onload=()=>_(!1),A(e,"src",this.order?.qrcode??R(e,"src")))},clearInterval(){clearInterval(this.nowInterval),this.nowInterval=s}},computed:{orderPrice(){let{order:e}=this;return T.format(e?e.total/100:0)},timmer(){if(!this.order||this.isExpired)return C;let e=Math.floor(Math.max((this.order?.due_time??0)-this.now,0)/1e3),r=Math.floor(e/3600),t=Math.floor(e%3600/60),o=e%60;return[r,t,o].map(n=>n.toString().padStart(2,"0")).join(":")},hasPaid(){return this.order?.pago??!1},isExpired(){return this.order?.expired??!1},getQRCode(){return this.order?.qrcode_text??I}},watch:{timmer(e){e===C&&this.patchOrder({expired:!0,total:this.order?.total??0,pago:this.order?.pago??!1})}}});G.mount(c("#pixProcess"));})();
