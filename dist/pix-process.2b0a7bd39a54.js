"use strict";(()=>{var g="; ";function i(e,t,r={}){if(e.length===0)throw new Error("'setCookie' should receive a valid cookie name");if(!["string","number","boolean"].includes(typeof t)||t.toString().length===0)throw new Error("'setCookie' should receive a valid cookie value");let o=[`${e}=${t}`];r?.expires&&r?.expires instanceof Date&&o.push("expires="+r.expires.toUTCString()),r.maxAge&&o.push(`maxAge=${r.maxAge}`),r?.sameSite&&typeof r?.sameSite=="string"&&o.push(`SameSite=${r?.sameSite}`),r?.path&&o.push(`path=${r?.path}`),r?.domain&&o.push(`domain=${r?.path}`),r?.httpOnly&&o.push("HttpOnly"),r?.secure&&o.push("Secure");let s=o.join(g);return document.cookie=s,s}var d="__Host-Talho-Session-Cookie",u="X-Talho-Session";function a(e){let t=this?.get(u);return t&&i(d,t,{path:"/",secure:!0,sameSite:"Strict",maxAge:c(90)}),{message:e,succeeded:!1}}function l(e){let t=this?.get(u);return t&&i(d,t,{path:"/",secure:!0,sameSite:"Strict",maxAge:c(90)}),{data:e,succeeded:!0}}function c(e){return 86400*1e3*e}var p=new Intl.NumberFormat("pt-BR",{currency:"BRL",style:"currency"});var{createApp:E}=window.Vue,T="",n=null,h="00:00:00",O="oculto",x="https://xef5-44zo-gegm.b2.xano.io/api:5lp3Lw8X";function C(e){return _(f("[data-wtf-loader]"),O,!e)}function _(e,t,r){return e?e.classList.toggle(t,r):!1}function v(e){if(typeof e!="string")return null;try{return JSON.parse(e)}catch{return n}}function m(e,t={}){let r=new URL(`${location.protocol}//${location.hostname}`),o=new URL(e,r);for(let[s,S]of Object.entries(t))o.searchParams.set(s,S);return o.toString()}function f(e,t=document){return t?t.querySelector(e):n}var R=E({name:"PIXProcessPage",setup(){return{hasEventSource:Vue.shallowRef(n)}},data(){return{now:Date.now(),hasCopied:!1,order:n,nowInterval:n}},async created(){this.hasEventSource="EventSource"in window;let t=new URLSearchParams(location.search).get("order");if(!t){location.href="/";return}let r=await this.getOrder(t);if(!r.succeeded||r.data.payment_method!=="pix"){location.href=m("/");return}if(this.order=r.data,this.setQRImage(),r.data.pago){setTimeout(()=>{location.href=m("/pagamento/confirmacao-do-pedido",{order:t})},5e3);return}if(!r.data.expired&&(this.nowInterval=setInterval(()=>this.now=Date.now(),1e3),this.hasEventSource))return this.pollOrder(t)},methods:{pollOrder(e){let t=new EventSource(`${x}/confirm-pix/${e}`);t.addEventListener("message",async r=>{let o=v(r.data);o!==n&&(this.patchOrder({...o,expired:h===this.timmer||o.expired}),(this.hasPaid||this.isExpired)&&(t.readyState!==t.CLOSED&&t.close(),this.clearInterval()),this.hasPaid&&setTimeout(()=>{location.href=m("/pagamento/confirmacao-do-pedido",{order:e})},5e3))}),document.addEventListener("beforeunload",()=>{t.readyState!==t.CLOSED&&(t.close(),this.clearInterval())})},patchOrder({pago:e,expired:t,total:r}){this.order&&(this.order.pago=e,this.order.total=r,this.order.expired=t)},async getOrder(e){let t="Falha ao capturar o pedido";try{let r=await fetch(`${x}/confirm-pix/${e}/rest`,{headers:{Accept:"application/json"}});if(!r.ok){let s=await r.json();return a(s?.message??t)}let o=await r.json();return l(o)}catch{return a(t)}},async handleCopyQRCode(){if(!this.hasCopied){if(this.hasCopied=!0,navigator.clipboard.writeText)await navigator.clipboard.writeText(this.order?.qrcode_text??"");else{let e=document.createElement("input");document.body.appendChild(e),e.value=this.order?.qrcode_text??"",e.select(),document.execCommand("copy"),document.body.removeChild(e)}setTimeout(()=>this.hasCopied=!1,3e3)}},setQRImage(){let e=f("[data-wtf-qr-code-image]");e&&(e.onload=()=>{C(!1)},e.setAttribute("src",this.order?.qrcode??e.getAttribute("src")))},clearInterval(){clearInterval(this.nowInterval),this.nowInterval=n}},computed:{orderPrice(){let{order:e}=this;return p.format(e?e.total/100:0)},timmer(){if(!this.order||this.isExpired)return h;let e=Math.floor(Math.max((this.order?.due_time??0)-this.now,0)/1e3),t=Math.floor(e/3600),r=Math.floor(e%3600/60),o=e%60;return[t,r,o].map(s=>s.toString().padStart(2,"0")).join(":")},hasPaid(){return this.order?.pago??!1},isExpired(){return this.order?.expired??!1},getQRCode(){return this.order?.qrcode_text??T}},watch:{timmer(e){e===h&&this.patchOrder({expired:!0,total:this.order?.total??0,pago:this.order?.pago??!1})}}});R.mount(f("#pixProcess"));})();
